<!DOCTYPE html>
<html lang="en" class="pf-m-redhat-font">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@patternfly/patternfly/patternfly.css" crossorigin="anonymous">
    <title>{% block title %}{% endblock %}</title>
    <style>
        pre {
            background: #cccccc;
            padding: 5px;
            -webkit-box-shadow: 0 0 8px 0 rgba(0, 0, 0, 0.75);
            -moz-box-shadow: 0 0 8px 0 rgba(0, 0, 0, 0.75);
            box-shadow: 0 0 8px 0 rgba(0, 0, 0, .1);
        }

        .progress-bar {
            display: flex;
            flex-direction: column;
            justify-content: center;
            color: #fff;
            text-align: center;
            min-width: 10em;
            height: 20px;
        }

        .progress {
            display: flex;
            height: 1rem;
            font-size: .75rem;
            background-color: #e9ecef;
        }
    </style>
    <script>
        // Search engine of rules
        $(document).ready(function () {
            $("#input-search-rule").on('keypress',function(e) {
                if(e.which == 13) {
                    var value = $(this).val().toLowerCase();
                    $("#rule-table tbody[rule-id]").hide().filter(function () {
                        var is_matched_title = $(this).attr("title").toLowerCase().includes(value);
                        var is_matched_rule_id = $(this).attr("rule-id").toLowerCase().includes(value);
                        return is_matched_title || is_matched_rule_id;
                    }).show();
                }
            });
        });
        function toggle_OVAL_operator(self) {
            self.parent().parent().toggleClass('pf-m-expanded');
            self.parent().parent().children('ul').children().toggle();
        }
        function show_OVAL_details(self, info_id) {
            self.parent().children(info_id).toggleClass('pf-m-expanded').toggle();
            self.text((self.text() == 'Show test details') ? 'Hide test details' : 'Show test details');
            self.attr('aria-label', (self.attr('aria-label') == 'Show test details') ? 'Hide test details' : 'Show test details');
        }
        function show_evaluation_characteristics(self) {
            self.toggleClass('pf-m-expanded');
            self.parent().parent().children('.pf-c-accordion__expanded-content').toggleClass('pf-m-expanded').toggle();
        }
        function show_rule_detail(self, rule_id) {
            self.toggleClass('pf-m-expanded');
            self.parent().parent().parent().children('.pf-c-table__expandable-row').toggleClass('pf-m-expanded');
            generate_oval_tree(self, rule_id);
        }

        const NEGATION_COLOR = { 'pf-m-green': 'pf-m-red', 'pf-m-red': 'pf-m-green', '': '' };
        const NEGATION_ICON = { 'fa-check': 'fa-times', 'pf-m-red': 'fa-check', 'fa-question-circle': 'fa-question-circle' };
        const COLOR_TRANSLATION = { 'pf-m-green': '--pf-global--success-color--200', 'pf-m-red': '--pf-global--danger-color--200', '': '' };

        let tree_content = ''
        function generate_oval_tree(self, rule_id) {
            var searched_div = "div #oval_tree_of_rule_" + rule_id;
            var div_with_tree = self.parent().parent().parent().find(searched_div);
            var tree_data = JSON.parse(div_with_tree.attr("data"));
            tree_content = '<div class="pf-c-tree-view pf-m-guides pf-m-no-background"><ul class="pf-c-tree-view__list" role="tree">';
            if (div_with_tree.attr("is_rendered") == 'false' && tree_data != undefined) {
                render_OVAL_tree(tree_data);
                tree_content += '<\/ul><\/div>';
                div_with_tree.append(tree_content);
                div_with_tree.attr("is_rendered", 'true');
            }
        }

        function render_OVAL_tree(root) {
            if (root.node_type != 'value') {
                tree_content += '<li class="pf-c-tree-view__list-item pf-m-expanded" role="treeitem" aria-expanded="true" tabindex="0">';
                render_OVAL_operator(root);
            }
            if (root.children) {
                tree_content += '<ul class="pf-c-tree-view__list" role="group">';

                for (const child of root.children) {
                    if (child.node_type == "value") {
                        render_OVAL_test(child);
                    } else {
                        render_OVAL_tree(child);
                    }
                }
                tree_content += '<\/ul>';
            }
            if (root.node_type != 'value') {
                tree_content += '<\/li>';
            }
        }

        function render_OVAL_test(node) {
            tree_content +=
                '<li class="pf-c-tree-view__list-item" role="treeitem" tabindex="-1">' +
                    '<div class="pf-c-tree-view__content">' +
                        '<div class="pf-c-tree-view__node" tabindex="0">' +
                            '<div class="pf-c-tree-view__node-container">' +
                                '<div class="pf-c-tree-view__node-content">' +
                                    '<span class="pf-c-tree-view__node-text">'; // Start span
            var color = '';
            var icon = 'fa-question-circle';
            if (node.value == 'true') {
                color = 'pf-m-green';
                icon = 'fa-check';
            } else if (node.value == 'false') {
                color = 'pf-m-red';
                icon = 'fa-times';
            }

            if (node.negation) {
                tree_content +=
                    '<span style="color: var(' + COLOR_TRANSLATION[NEGATION_COLOR[color]] + ')">'+
                        '<span class="pf-c-label__icon">' +
                            '<i class="fas fa-fw ' + NEGATION_ICON[icon] + '" aria-hidden="true"><\/i>'+
                        '<\/span>' +
                        '<b> NOT <\/b>' +
                    '<\/span>';
            }

            tree_content += '<span style="color: var(' + COLOR_TRANSLATION[color] + ');">';
            if (!node.negation) {
                tree_content +=
                    '<span class="pf-c-label__icon">' +
                        '<i class="fas fa-fw ' + icon + '" aria-hidden="true"><\/i>' +
                    '<\/span>';
            }
            var test_id = node.node_id.replace("oval:ssg-", "").replace(":tst:1", "");
            tree_content +=
                '<b> ' + test_id + '<\/b>' +
                '<\/span>' +
                '<span class="pf-c-label ' + color + '">' +
                    '<span class="pf-c-label__content"> ' + node.tag + '<\/span>' +
                '<\/span>' +
                '<span class="pf-c-label ' + color + '">' +
                    '<span class="pf-c-label__content">' +
                        '<span class="pf-c-label__icon">' +
                            '<i class="fas fa-fw ' + icon + '" aria-hidden="true"><\/i>' +
                        '<\/span>' +
                        node.value +
                    '<\/span>' +
                '<\/span>' +
            '<\/span>'; // End span
            var info_id = 'info_of_test_' + test_id;
            tree_content +=
                '<button '+
                    'class="pf-c-button pf-m-inline pf-m-link" onClick="show_OVAL_details($(this), \'div #' + info_id + '\');" ' +
                    'type="button" '+
                    'aria-label="Show test details">Show test details<\/button>'+
                    '<div id="' + info_id + '" class="pf-c-accordion__expanded-content" style="display: none;" aria-label="OVAL test info">' +
                        '<div class="pf-c-accordion__expanded-content-body">';
            insert_OVAL_test_info(node);
            tree_content += '<\/div><\/div><\/div><\/div><\/div><\/div><\/li>';
        }


        function render_OVAL_operator(node) {
            tree_content +=
                '<div class="pf-c-tree-view__content">' +
                    '<button '+
                        'class="pf-c-tree-view__node" '+
                        'onClick="toggle_OVAL_operator($(this));" ' +
                        'title="Onclick shows or hides child nodes of the OVAL tree.">' +
                        '<div class="pf-c-tree-view__node-container">' +
                            '<div class="pf-c-tree-view__node-toggle">' +
                                '<span class="pf-c-tree-view__node-toggle-icon">'+
                                    '<i class="fas fa-angle-right" aria-hidden="true"><\/i>' +
                                '<\/span>' +
                            '<\/div>' +
                        '<div class="pf-c-tree-view__node-content">' +
                            '<span class="pf-c-tree-view__node-text">';
            var color = '';
            var icon = 'fa-question-circle';
            if (node.value == 'true') {
                color = 'pf-m-green';
                icon = 'fa-check';
            } else if (node.value == 'false') {
                color = 'pf-m-red';
                icon = 'fa-times';
            }

            if (node.negation) {
                tree_content +=
                    '<span style="color: var(' + COLOR_TRANSLATION[NEGATION_COLOR[color]] + ')">' +
                        '<span class="pf-c-label__icon">' +
                            '<i class="fas fa-fw ' + NEGATION_ICON[icon] + '" aria-hidden="true"><\/i>' +
                        '<\/span>' +
                        '<b> NOT <\/b>' +
                    '<\/span>';
            }
            tree_content += '<span style="color: var(' + COLOR_TRANSLATION[color] + ');">';
            if (!node.negation) {
                tree_content +=
                    '<span class="pf-c-label__icon">' +
                        '<i class="fas fa-fw ' + icon + '" aria-hidden="true"><\/i>' +
                    '<\/span>';
            }
            tree_content +=
                '<b>' + node.node_type + '<\/b>' +
                '<\/span>' +
                '<span class="pf-c-label ' + color + '">' +
                    '<span class="pf-c-label__content">' + node.tag + '<\/span>' +
                '<\/span>' +
                '<span class="pf-c-label ' + color + '">' +
                    '<span class="pf-c-label__content">' +
                        '<span class="pf-c-label__icon">' +
                            '<i class="fas fa-fw ' + icon + '" aria-hidden="true"><\/i>' +
                        '<\/span>' +
                        node.value +
                    '<\/span>' +
                '<\/span>' +
                '<\/span><\/div><\/div><\/button><\/div>';
        }

        function insert_OVAL_test_info(node) {
            tree_content +=
                '<span class="pf-c-label pf-m-blue">' +
                    '<span class="pf-c-label__content">' +
                        node.test_info.comment +
                    '<\/span>' +
                '<\/span>' +
                '<span class="pf-c-label">' +
                    '<span class="pf-c-label__content">' +
                        node.test_info.test_id +
                    '<\/span>' +
                '<\/span>';

            if (node.test_info.oval_object) {

                if (node.test_info.oval_object.flag == "complete") {
                    tree_content += '<p>Following items have been found on the system:<\/p>';
                } else {
                    tree_content +=
                        '<p>No items have been found conforming to the following objects:<br>Object <b>' +
                        node.test_info.oval_object.object_id +
                        '<\/b> of type <b>' + node.test_info.oval_object.object_type + '<\/b><\/p>';
                }
                tree_content +=
                    '<div  style="width: 0; min-width: 100em; overflow-x: auto;">' +
                        '<table class="pf-c-table pf-m-compact pf-m-grid-md" style="table-layout:auto;" role="grid">' +
                            '<thead>' + // Start thead
                                '<tr role="row">';
                objects = [];
                for (object of node.test_info.oval_object.object_data) {
                    objects.push(filter_object(object, node));
                }
                for (item of get_header_items(objects)) {
                    tree_content += '<th role="columnheader" scope="col">';
                    tree_content += format_header_item(item) + '<\/th>';
                }

                tree_content +=
                    '<\/tr><\/thead>' + // End thead
                    '<tbody role="rowgroup">';
                for (row of objects) {
                    tree_content += '<tr role="row">';
                    for (key in row) {
                        tree_content += '<td role="cell" data-label="' + key + '">' + row[key] + '<\/td>';
                    }
                    tree_content += '<\/tr>';
                }
                tree_content += '<\/tbody><\/table><\/div>';
            }
        }
        function get_header_items(objects) {
            out = [];
            for (object of objects) {
                for (key in object) {
                    if (!out.includes(key)) {
                        out.push(key);
                    }
                }
            }
            return out;
        }
        function format_header_item(str) {
            var text = remove_uuid(str);
            var text_with_spaces = text.replace("_", " ");
            return text_with_spaces.charAt(0).toUpperCase() + text_with_spaces.slice(1);
        }
        function remove_uuid(str) {
            var index_special_char = str.indexOf('@');
            var text = str.substring(0, index_special_char != -1 ? index_special_char : str.length);
            return text;
        }
        function filter_permissions(object) {
            var permission = {
                'uread': null,
                'uwrite': null,
                'uexec': null,
                'gread': null,
                'gwrite': null,
                'gexec': null,
                'oread': null,
                'owrite': null,
                'oexec': null
            };
            var new_object = {};
            Object.keys(object).forEach(key => {
                if (key in permission) {
                    permission[key] = object[key];
                } else {
                    new_object[key] = object[key];
                }
            });
            for (const key in permission) {
                if (permission[key] === null) {
                    return object;
                }
            }
            var out = '<code>';
            Object.keys(permission).forEach(key => {
                if (permission[key] == 'true') {
                    switch (key.substring(1, key.length)) {
                        case 'read':
                            out += "r";
                            break;
                        case 'write':
                            out += "w";
                            break;
                        case 'exec':
                            out += "x";
                            break;
                        default:
                            // pass
                            break;
                    }
                } else {
                    out += "-";
                }
            });
            out += '<\/code>';
            new_object['permission'] = out;
            return new_object;
        }
        function filter_object(object, node) {
            if (node.test_info.oval_object.object_type == 'textfilecontent54_object') {
                if ("filepath" in object && "text" in object) {
                    return {
                        "filepath": object["filepath"],
                        "content": object["text"]
                    };
                }
            }
            return filter_permissions(object);
        }
    </script>
</head>

<body>
    <div class="pf-c-page">
        <header class="pf-c-page__header">
            <div class="pf-c-page__header-brand">
                <svg version="1.1" width="52" height="52" alt="Open SCAP logo" role="img">
                    <g transform="matrix(0.75266991,0,0,0.75266991,-17.752968,-104.57468)">
                        <path
                            d="m 24.7,173.5 c 0,-9 3.5,-17.5 9.9,-23.9 6.8,-6.8 15.7,-10.4 25,-10 8.6,0.3 16.9,3.9 22.9,9.8 6.4,6.4 9.9,14.9 10,23.8 0.1,9.1 -3.5,17.8 -10,24.3 -13.2,13.2 -34.7,13.1 -48,-0.1 -1.5,-1.5 -1.9,-4.2 0.2,-6.2 l 9,-9 c -2,-3.6 -4.9,-13.1 2.6,-20.7 7.6,-7.6 18.6,-6 24.4,-0.2 3.3,3.3 5.1,7.6 5.1,12.1 0.1,4.6 -1.8,9.1 -5.3,12.5 -4.2,4.2 -10.2,5.8 -16.1,4.4 -1.5,-0.4 -2.4,-1.9 -2.1,-3.4 0.4,-1.5 1.9,-2.4 3.4,-2.1 4.1,1 8,-0.1 10.9,-2.9 2.3,-2.3 3.6,-5.3 3.6,-8.4 0,0 0,-0.1 0,-0.1 0,-3 -1.3,-5.9 -3.5,-8.2 -3.9,-3.9 -11.3,-4.9 -16.5,0.2 -6.3,6.3 -1.6,14.1 -1.6,14.2 1.5,2.4 0.7,5 -0.9,6.3 l -8.4,8.4 c 9.9,8.9 27.2,11.2 39.1,-0.8 5.4,-5.4 8.4,-12.5 8.4,-20 0,-0.1 0,-0.2 0,-0.3 -0.1,-7.5 -3,-14.6 -8.4,-19.9 -5,-5 -11.9,-8 -19.1,-8.2 -7.8,-0.3 -15.2,2.7 -20.9,8.4 -8.7,8.7 -8.7,19 -7.9,24.3 0.3,2.4 1.1,4.9 2.2,7.3 0.6,1.4 0,3.1 -1.4,3.7 -1.4,0.6 -3.1,0 -3.7,-1.4 -1.3,-2.9 -2.2,-5.8 -2.6,-8.7 -0.3,-1.7 -0.4,-3.5 -0.4,-5.2 z"
                            style="fill:#0066CC" />
                    </g>
                </svg>
                &nbsp;&nbsp;&nbsp;
                <h1 class="pf-c-title pf-m-4xl">{{ report.title }}</h1>
            </div>
        </header>
        <main class="pf-c-page__main" tabindex="-1">
            <section class="pf-c-page__main-section pf-m-no-fill">
                {% block content%}

                {% endblock %}
            </section>
    </div>
</body>
</html>
